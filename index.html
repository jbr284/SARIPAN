<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SARIPAN</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#d32f2f">

  <style>
    /* Global Styles */
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f7fb;
      margin: 0;
      padding: 0;
    }

    .container {
      background-color: #fff;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      position: relative; /* Para posicionar elementos */
    }

    /* Header */
    .header-app {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      position: relative;
    }

    h1 {
      color: #007bff;
      margin: 0;
      font-size: 24px;
      text-align: center;
    }

    .subtitulo {
      text-align: center;
      margin-bottom: 20px;
      font-size: 16px;
      color: #555;
    }

    /* Bot√£o Voltar */
    .btn-voltar {
      position: absolute;
      left: 0;
      top: 0;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-voltar:hover { background-color: #5a6268; }

    /* Estilos do Resumo Detalhado */
    .resumo-box {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .resumo-titulo {
      font-size: 18px;
      font-weight: bold;
      color: #0d47a1;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .resumo-lista {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .resumo-lista li {
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
      color: #333;
      font-size: 16px;
    }
    .resumo-total {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      text-align: right;
      color: #d32f2f;
    }

    /* Inputs e Controles */
    .grid-input { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    label { font-weight: 600; margin-bottom: 5px; display: block; color: #333; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; background: #fff; box-sizing: border-box;}
    
    .apontamento-box { background: #e3f2fd; padding: 20px; border-radius: 12px; border: 1px solid #90caf9; margin-bottom: 25px; }

    /* Bot√µes de A√ß√£o */
    .buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    button.action-btn { padding: 14px 24px; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 14px; border: none; color: white; flex: 1; min-width: 120px; }
    
    .btn-verde { background-color: #28a745; }
    .btn-laranja { background-color: #fd7e14; }
    .btn-azul { background-color: #17a2b8; }
    .btn-vermelho { background-color: #dc3545; }

    /* Tabela */
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background-color: #007bff; color: white; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  
  <div id="inicio" style="text-align: center; padding: 40px;">
    <h1 style="font-size: 32px; margin-bottom: 10px;">SARIPAN</h1>
    <p class="subtitulo">Gest√£o de Servi√ßos</p>
    <div style="display: flex; flex-direction: column; gap: 15px; max-width: 300px; margin: 30px auto;">
      <button class="action-btn btn-verde" onclick="entrarApontamento()">üìã Modo Apontamento</button>
      <button class="action-btn btn-azul" onclick="entrarAcompanhamento()">üëÅÔ∏è Modo Acompanhamento</button>
    </div>
  </div>

  <div id="app" class="container hidden">
    
    <div class="header-app">
        <button class="btn-voltar" onclick="voltarInicio()">‚¨Ö Voltar</button>
        <h1>SARIPAN</h1>
    </div>
    
    <div class="resumo-box" id="boxResumo">
        <div class="resumo-titulo" id="tituloQuinzena">Carregando...</div>
        <p style="font-weight:bold; color:#555;">Dias trabalhados:</p>
        <ul class="resumo-lista" id="listaResumo">
            </ul>
        <div class="resumo-total" id="textoTotalDiarias">Total: 0 di√°rias</div>
        <div id="totalDinheiroAdmin" style="text-align:right; color:#28a745; font-size:14px; margin-top:5px;" class="hidden"></div>
    </div>

    <div id="painelControle" class="hidden">
        <div class="apontamento-box">
            <h3 style="margin-top:0; color:#0d47a1;">Novo Registro</h3>
            <label>Data do Servi√ßo:</label>
            <input type="date" id="dataServico" style="margin-bottom: 15px;">
            <div class="grid-input">
                <div>
                    <label>Carga Hor√°ria:</label>
                    <select id="tipoCarga">
                        <option value="1">Meio Expediente</option>
                        <option value="2">Dia Todo</option>
                    </select>
                </div>
                <div>
                    <label>Tipo de Dia:</label>
                    <select id="tipoDia">
                        <option value="1">Dia √ötil</option>
                        <option value="2">Domingo / Feriado</option>
                    </select>
                </div>
            </div>
            <div class="grid-input">
                <div><label>Valor Base (R$):</label><input type="number" id="valorBase" value="130.00"></div>
                <div><label>Previs√£o:</label><input type="text" id="valorCalculadoPreview" value="R$ 130,00" readonly style="background:#eee;"></div>
            </div>
            <button class="action-btn btn-verde" style="width:100%;" onclick="adicionarRegistro()">‚úÖ Confirmar Apontamento</button>
        </div>
        <div class="buttons">
            <button class="action-btn btn-laranja" onclick="fecharQuinzena()">‚ö†Ô∏è Fechar Quinzena</button>
            <button class="action-btn btn-azul" onclick="exportarPDF()">üìÑ Gerar PDF</button>
        </div>
    </div>

    <div class="table-container">
        <table id="tabelaRegistros">
            <thead>
                <tr><th>Data</th><th>Detalhes</th><th id="colunaValor">Valor</th><th id="colunaAcao">A√ß√£o</th></tr>
            </thead>
            <tbody id="tbodyRegistros"></tbody>
        </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDSVOvdkIaV37Cxm3btE_T3zuDOQm2Uu5s",
      authDomain: "saripan-db.firebaseapp.com",
      databaseURL: "https://saripan-db-default-rtdb.firebaseio.com",
      projectId: "saripan-db",
      storageBucket: "saripan-db.firebasestorage.app",
      messagingSenderId: "1:80320414744:web:958b3a99462d97575e2f6d",
      appId: "G-9W62N5PFV9"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let modoAtual = ""; 
    let registros = [];

    // --- NAVEGA√á√ÉO ---
    function voltarInicio() {
        document.getElementById('app').classList.add('hidden');
        document.getElementById('inicio').classList.remove('hidden');
        modoAtual = "";
    }

    // --- C√ÅLCULO DE PREVIEW ---
    function atualizarPreview() {
        const base = parseFloat(document.getElementById('valorBase').value) || 0;
        const carga = parseInt(document.getElementById('tipoCarga').value);
        const tipo = parseInt(document.getElementById('tipoDia').value);
        let mult = (tipo === 2 && carga === 2) ? 4 : (carga * tipo);
        document.getElementById('valorCalculadoPreview').value = `R$ ${(base * mult).toFixed(2)}`;
    }
    ['valorBase', 'tipoCarga', 'tipoDia'].forEach(id => document.getElementById(id).addEventListener('input', atualizarPreview));

    // --- LOGIN ---
    window.entrarApontamento = async function() {
        if(prompt("Senha:") !== "0305") return alert("Senha incorreta"); 
        modoAtual = "admin";
        iniciarApp();
    };
    window.entrarAcompanhamento = async function() {
        modoAtual = "view";
        iniciarApp();
    };

    async function iniciarApp() {
        document.getElementById('inicio').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        if (modoAtual === "admin") {
            document.getElementById('painelControle').classList.remove('hidden');
            document.getElementById('colunaAcao').classList.remove('hidden');
            document.getElementById('colunaValor').classList.remove('hidden');
            document.getElementById('totalDinheiroAdmin').classList.remove('hidden');
            document.getElementById('dataServico').valueAsDate = new Date();
        } else {
            document.getElementById('painelControle').classList.add('hidden');
            document.getElementById('colunaAcao').classList.add('hidden');
            document.getElementById('colunaValor').classList.add('hidden');
            document.getElementById('totalDinheiroAdmin').classList.add('hidden');
        }
        await carregarDados();
    }

    // --- L√ìGICA DE DADOS ---
    async function adicionarRegistro() {
        const dataInput = document.getElementById('dataServico').value;
        if (!dataInput) return alert("Selecione uma data!");
        
        const base = parseFloat(document.getElementById('valorBase').value);
        const carga = parseInt(document.getElementById('tipoCarga').value);
        const tipoDia = parseInt(document.getElementById('tipoDia').value);
        let mult = (tipoDia === 2 && carga === 2) ? 4 : (carga * tipoDia);

        registros.push({
            id: Date.now(),
            data: dataInput,
            dataFormatada: dataInput.split('-').reverse().join('/'),
            carga: carga,
            tipoDia: tipoDia,
            multiplicador: mult,
            valor: base * mult,
            base: base
        });
        
        registros.sort((a, b) => new Date(a.data) - new Date(b.data));
        atualizarInterface();
        await salvarFirebase();
    }

    function removerRegistro(id) {
        if(confirm("Excluir?")) {
            registros = registros.filter(r => r.id !== id);
            atualizarInterface();
            salvarFirebase();
        }
    }

    function atualizarInterface() {
        // TABELA
        const tbody = document.getElementById('tbodyRegistros');
        tbody.innerHTML = "";
        registros.forEach(reg => {
            let desc = "";
            if (reg.tipoDia === 2) desc += "üóìÔ∏è Feriado ";
            if (reg.carga === 2) desc += "‚è∞ Dia Todo";
            if (desc === "") desc = "Meio Expediente";
            
            let html = `<td>${reg.dataFormatada}</td><td>${desc}</td>`;
            if (modoAtual === "admin") html += `<td>R$ ${reg.valor.toFixed(2)}</td><td><button class="action-btn btn-vermelho" style="padding: 5px 10px; min-width: auto;" onclick="removerRegistro(${reg.id})">X</button></td>`;
            else html += `<td class="hidden"></td><td class="hidden"></td>`;
            
            const tr = document.createElement('tr');
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        // RESUMO DETALHADO
        const lista = document.getElementById('listaResumo');
        lista.innerHTML = "";
        
        let contadores = { normal: 0, dupla: 0, feriadoNormal: 0, feriadoTodo: 0 };
        let totalDiarias = 0;
        let totalValor = 0;

        registros.forEach(reg => {
            totalDiarias += reg.multiplicador;
            totalValor += reg.valor;

            if (reg.carga === 1 && reg.tipoDia === 1) contadores.normal++;
            else if (reg.carga === 2 && reg.tipoDia === 1) contadores.dupla++;
            else if (reg.carga === 1 && reg.tipoDia === 2) contadores.feriadoNormal++;
            else if (reg.carga === 2 && reg.tipoDia === 2) contadores.feriadoTodo++;
        });

        let textoPeriodo = "Sem registros";
        if (registros.length > 0) {
            const dataObj = new Date(registros[0].data);
            const dia = dataObj.getUTCDate();
            const mes = dataObj.toLocaleString('pt-BR', { month: 'long' });
            const quinzena = dia <= 15 ? "1¬™ Quinzena" : "2¬™ Quinzena";
            textoPeriodo = `${quinzena} de ${mes.charAt(0).toUpperCase() + mes.slice(1)}`;
        }
        document.getElementById('tituloQuinzena').innerText = textoPeriodo;

        if (contadores.normal > 0) lista.innerHTML += `<li>${contadores.normal} di√°ria(s) normal</li>`;
        if (contadores.dupla > 0) lista.innerHTML += `<li>${contadores.dupla} di√°ria(s) dupla</li>`;
        if (contadores.feriadoNormal > 0) lista.innerHTML += `<li>${contadores.feriadoNormal} feriado(s) normal</li>`;
        if (contadores.feriadoTodo > 0) lista.innerHTML += `<li>${contadores.feriadoTodo} feriado(s) dia todo</li>`;

        if (registros.length === 0) lista.innerHTML = "<li>Nenhum dia trabalhado registrado.</li>";

        document.getElementById('textoTotalDiarias').innerText = `Total: ${totalDiarias} di√°rias`;
        document.getElementById('totalDinheiroAdmin').innerText = `(Admin: R$ ${totalValor.toFixed(2)})`;
    }

    async function salvarFirebase() {
        if (modoAtual === "admin") await database.ref('saripan').set({ ultAtualizacao: new Date().toISOString(), dados: registros });
    }
    async function carregarDados() {
        const snap = await database.ref('saripan').get();
        if (snap.exists()) registros = snap.val().dados || [];
        atualizarInterface();
    }
    async function fecharQuinzena() {
        if(confirm("Limpar tudo para nova quinzena?")) { registros = []; atualizarInterface(); await salvarFirebase(); }
    }

    // --- PDF ---
    async function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18); doc.setTextColor(0,123,255); doc.text("SARIPAN - Relat√≥rio", 14, 20);
        doc.setFontSize(12); doc.setTextColor(0,0,0); doc.text("Prestador: Jo√£o Batista Rosa", 14, 30);
        doc.text(`Refer√™ncia: ${document.getElementById('tituloQuinzena').innerText}`, 14, 38);

        let dadosTabela = [];
        let totalGeral = 0; let totalDiarias = 0; let diasNormais = 0;

        registros.forEach(reg => {
            totalGeral += reg.valor; totalDiarias += reg.multiplicador;
            if(reg.carga===1 && reg.tipoDia===1) diasNormais++;
            else {
                let txt = `Dia ${reg.dataFormatada}: `;
                if(reg.tipoDia===2) txt += "FERIADO ";
                if(reg.carga===2) txt += "DIA TODO"; else txt += "MEIO EXPEDIENTE";
                dadosTabela.push([txt, `R$ ${reg.valor.toFixed(2)}`]);
            }
        });

        let corpo = [];
        if(diasNormais > 0) corpo.push([`${diasNormais} Di√°rias Normais`, `R$ ${(diasNormais*130).toFixed(2)}`]);
        dadosTabela.forEach(d => corpo.push(d));

        doc.autoTable({ head: [['Descri√ß√£o','Valor']], body: corpo, startY: 45, theme: 'grid' });
        
        let y = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(12); doc.text(`Total de Di√°rias a Pagar: ${totalDiarias}`, 14, y);
        doc.text(`Valor Total: R$ ${totalGeral.toFixed(2)}`, 14, y+8);
        doc.save('relatorio.pdf');
    }
  </script>
</body>
</html>
