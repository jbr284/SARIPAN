<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SARIPAN</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#d32f2f">

  <style>
    /* Global Styles */
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f7fb;
      margin: 0;
      padding: 0;
    }

    .container {
      background-color: #fff;
      border-radius: 12px;
      padding: 20px;
      width: 95%;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    /* Header */
    .header-app {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      position: relative;
    }

    h1 {
      color: #007bff;
      margin: 0;
      font-size: 24px;
      text-align: center;
    }

    .subtitulo {
      text-align: center;
      margin-bottom: 20px;
      font-size: 16px;
      color: #555;
    }

    /* Bot√£o Voltar */
    .btn-voltar {
      position: absolute;
      left: 0;
      top: 0;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-voltar:hover { background-color: #5a6268; }

    /* Estilos do Resumo Detalhado */
    .resumo-box {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .resumo-titulo {
      font-size: 18px;
      font-weight: bold;
      color: #0d47a1;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .resumo-lista {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .resumo-lista li {
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
      color: #333;
      font-size: 16px;
    }
    .resumo-total {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      text-align: right;
      color: #d32f2f;
    }

    /* Total Monet√°rio no Rodap√© */
    .total-rodape {
      margin-top: 15px;
      text-align: right;
      font-size: 20px;
      font-weight: bold;
      color: #28a745;
      padding: 15px;
      background-color: #e8f5e9;
      border-radius: 8px;
      border: 1px solid #c8e6c9;
    }

    /* Inputs e Controles */
    .grid-input { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    label { font-weight: 600; margin-bottom: 5px; display: block; color: #333; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; background: #fff; box-sizing: border-box;}
    
    .apontamento-box { background: #e3f2fd; padding: 20px; border-radius: 12px; border: 1px solid #90caf9; margin-bottom: 25px; }

    /* Bot√µes de A√ß√£o */
    .buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    button.action-btn { padding: 14px 24px; font-weight: bold; cursor: pointer; border-radius: 8px; font-size: 14px; border: none; color: white; flex: 1; min-width: 120px; }
    
    .btn-verde { background-color: #28a745; }
    .btn-laranja { background-color: #fd7e14; }
    .btn-azul { background-color: #17a2b8; }
    .btn-vermelho { background-color: #dc3545; }

    /* Tabela */
    .table-container { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background-color: #007bff; color: white; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  
  <div id="inicio" style="text-align: center; padding: 40px;">
    <h1 style="font-size: 32px; margin-bottom: 10px;">SARIPAN</h1>
    <p class="subtitulo">Gest√£o de Servi√ßos</p>
    <div style="display: flex; flex-direction: column; gap: 15px; max-width: 300px; margin: 30px auto;">
      <button class="action-btn btn-verde" onclick="entrarApontamento()">üìã Modo Apontamento</button>
      <button class="action-btn btn-azul" onclick="entrarAcompanhamento()">üëÅÔ∏è Modo Acompanhamento</button>
    </div>
  </div>

  <div id="app" class="container hidden">
    
    <div class="header-app">
        <button class="btn-voltar" onclick="voltarInicio()">‚¨Ö Voltar</button>
        <h1>SARIPAN</h1>
    </div>
    
    <div class="resumo-box" id="boxResumo">
        <div class="resumo-titulo" id="tituloQuinzena">Carregando...</div>
        <p style="font-weight:bold; color:#555;">Dias trabalhados:</p>
        <ul class="resumo-lista" id="listaResumo">
            </ul>
        <div class="resumo-total" id="textoTotalDiarias">Total: 0 di√°rias</div>
    </div>

    <div id="painelControle" class="hidden">
        <div class="apontamento-box">
            <h3 style="margin-top:0; color:#0d47a1;">Novo Registro</h3>
            <label>Data do Servi√ßo:</label>
            <input type="date" id="dataServico" style="margin-bottom: 15px;">
            <div class="grid-input">
                <div>
                    <label>Carga Hor√°ria:</label>
                    <select id="tipoCarga">
                        <option value="1">Di√°ria Normal</option>
                        <option value="2">Di√°ria Dupla</option>
                    </select>
                </div>
                <div>
                    <label>Tipo de Dia:</label>
                    <select id="tipoDia">
                        <option value="1">Dia √ötil</option>
                        <option value="2">Domingo</option>
                        <option value="3">Feriado</option>
                    </select>
                </div>
            </div>
            <div class="grid-input">
                <div><label>Valor Base (R$):</label><input type="number" id="valorBase" value="130.00"></div>
                <div><label>Previs√£o:</label><input type="text" id="valorCalculadoPreview" value="R$ 130,00" readonly style="background:#eee;"></div>
            </div>
            <button class="action-btn btn-verde" style="width:100%;" onclick="adicionarRegistro()">‚úÖ Confirmar Apontamento</button>
        </div>
        <div class="buttons">
            <button class="action-btn btn-laranja" onclick="fecharQuinzena()">‚ö†Ô∏è Fechar Quinzena</button>
            <button class="action-btn btn-azul" onclick="exportarPDF()">üìÑ Gerar PDF</button>
        </div>
    </div>

    <div class="table-container">
        <table id="tabelaRegistros">
            <thead>
                <tr><th>Data</th><th>Detalhes</th><th id="colunaValor">Valor</th><th id="colunaAcao">A√ß√£o</th></tr>
            </thead>
            <tbody id="tbodyRegistros"></tbody>
        </table>
    </div>

    <div id="footerTotal" class="total-rodape hidden">
        Total a Receber: R$ 0,00
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDSVOvdkIaV37Cxm3btE_T3zuDOQm2Uu5s",
      authDomain: "saripan-db.firebaseapp.com",
      databaseURL: "https://saripan-db-default-rtdb.firebaseio.com",
      projectId: "saripan-db",
      storageBucket: "saripan-db.firebasestorage.app",
      messagingSenderId: "1:80320414744:web:958b3a99462d97575e2f6d",
      appId: "G-9W62N5PFV9"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let modoAtual = ""; 
    let registros = [];

    // --- NAVEGA√á√ÉO ---
    function voltarInicio() {
        document.getElementById('app').classList.add('hidden');
        document.getElementById('inicio').classList.remove('hidden');
        modoAtual = "";
    }

    // --- C√ÅLCULO DE PREVIEW ---
    function atualizarPreview() {
        const base = parseFloat(document.getElementById('valorBase').value) || 0;
        const carga = parseInt(document.getElementById('tipoCarga').value);
        const tipoInput = parseInt(document.getElementById('tipoDia').value);
        
        let pesoDia = (tipoInput === 3) ? 2 : tipoInput;
        let mult = (pesoDia === 2 && carga === 2) ? 4 : (carga * pesoDia);
        document.getElementById('valorCalculadoPreview').value = `R$ ${(base * mult).toFixed(2)}`;
    }
    ['valorBase', 'tipoCarga', 'tipoDia'].forEach(id => document.getElementById(id).addEventListener('input', atualizarPreview));

    // --- LOGIN ---
    window.entrarApontamento = async function() {
        if(prompt("Senha:") !== "0305") return alert("Senha incorreta"); 
        modoAtual = "admin";
        iniciarApp();
    };
    window.entrarAcompanhamento = async function() {
        modoAtual = "view";
        iniciarApp();
    };

    async function iniciarApp() {
        document.getElementById('inicio').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        if (modoAtual === "admin") {
            document.getElementById('painelControle').classList.remove('hidden');
            document.getElementById('colunaAcao').classList.remove('hidden');
            document.getElementById('colunaValor').classList.remove('hidden');
            document.getElementById('footerTotal').classList.remove('hidden'); 
            document.getElementById('dataServico').valueAsDate = new Date();
        } else {
            document.getElementById('painelControle').classList.add('hidden');
            document.getElementById('colunaAcao').classList.add('hidden');
            document.getElementById('colunaValor').classList.add('hidden');
            document.getElementById('footerTotal').classList.add('hidden');
        }
        await carregarDados();
    }

    // --- L√ìGICA DE DADOS ---
    async function adicionarRegistro() {
        const dataInput = document.getElementById('dataServico').value;
        if (!dataInput) return alert("Selecione uma data!");
        
        const base = parseFloat(document.getElementById('valorBase').value);
        const carga = parseInt(document.getElementById('tipoCarga').value);
        const tipoDiaInput = parseInt(document.getElementById('tipoDia').value);
        
        let pesoDia = (tipoDiaInput === 3) ? 2 : tipoDiaInput;
        let mult = (pesoDia === 2 && carga === 2) ? 4 : (carga * pesoDia);

        registros.push({
            id: Date.now(),
            data: dataInput,
            dataFormatada: dataInput.split('-').reverse().join('/'),
            carga: carga,
            tipoDia: tipoDiaInput,
            multiplicador: mult,
            valor: base * mult,
            base: base
        });
        
        registros.sort((a, b) => new Date(a.data) - new Date(b.data));
        atualizarInterface();
        await salvarFirebase();
    }

    function removerRegistro(id) {
        if(confirm("Excluir?")) {
            registros = registros.filter(r => r.id !== id);
            atualizarInterface();
            salvarFirebase();
        }
    }

    function atualizarInterface() {
        // TABELA
        const tbody = document.getElementById('tbodyRegistros');
        tbody.innerHTML = "";
        
        registros.forEach(reg => {
            let desc = "";
            
            if (reg.tipoDia === 3) desc = "üéâ Feriado";
            else if (reg.tipoDia === 2) desc = "üóìÔ∏è Domingo";
            else desc = "Di√°ria Normal";
            
            if (reg.carga === 2) {
                if (reg.tipoDia === 1) {
                    desc = "‚è∞ Di√°ria Dupla";
                } else {
                    desc += " (Di√°ria Dupla)";
                }
            }
            
            let html = `<td>${reg.dataFormatada}</td><td>${desc}</td>`;
            if (modoAtual === "admin") html += `<td>R$ ${reg.valor.toFixed(2)}</td><td><button class="action-btn btn-vermelho" style="padding: 5px 10px; min-width: auto;" onclick="removerRegistro(${reg.id})">X</button></td>`;
            else html += `<td class="hidden"></td><td class="hidden"></td>`;
            
            const tr = document.createElement('tr');
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        // RESUMO E T√çTULO
        const lista = document.getElementById('listaResumo');
        lista.innerHTML = "";
        
        let contadores = { 
            normal: 0, 
            dupla: 0, 
            domingo: 0, 
            feriado: 0,
            domingoDupla: 0,
            feriadoDupla: 0
        };
        let totalDiarias = 0;
        let totalValor = 0;

        registros.forEach(reg => {
            totalDiarias += reg.multiplicador;
            totalValor += reg.valor;

            if (reg.carga === 1 && reg.tipoDia === 1) contadores.normal++;
            else if (reg.carga === 2 && reg.tipoDia === 1) contadores.dupla++;
            else if (reg.carga === 1 && reg.tipoDia === 2) contadores.domingo++;
            else if (reg.carga === 1 && reg.tipoDia === 3) contadores.feriado++;
            else if (reg.carga === 2 && reg.tipoDia === 2) contadores.domingoDupla++;
            else if (reg.carga === 2 && reg.tipoDia === 3) contadores.feriadoDupla++;
        });

        let textoPeriodo = "Sem registros";
        if (registros.length > 0) {
            const dataObj = new Date(registros[0].data);
            const dia = dataObj.getUTCDate();
            
            // CORRE√á√ÉO: Meses manuais para evitar erro de fuso
            const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const mes = meses[dataObj.getUTCMonth()];

            const quinzena = dia <= 15 ? "1¬™ Quinzena" : "2¬™ Quinzena";
            textoPeriodo = `${quinzena} de ${mes}`;
        }
        document.getElementById('tituloQuinzena').innerText = textoPeriodo;

        if (contadores.normal > 0) lista.innerHTML += `<li>${contadores.normal} di√°ria(s) normal</li>`;
        if (contadores.dupla > 0) lista.innerHTML += `<li>${contadores.dupla} di√°ria(s) dupla</li>`;
        if (contadores.domingo > 0) lista.innerHTML += `<li>${contadores.domingo} domingo(s)</li>`;
        if (contadores.feriado > 0) lista.innerHTML += `<li>${contadores.feriado} feriado(s)</li>`;
        if (contadores.domingoDupla > 0) lista.innerHTML += `<li>${contadores.domingoDupla} domingo(s) Di√°ria Dupla</li>`;
        if (contadores.feriadoDupla > 0) lista.innerHTML += `<li>${contadores.feriadoDupla} feriado(s) Di√°ria Dupla</li>`;

        if (registros.length === 0) lista.innerHTML = "<li>Nenhum dia trabalhado registrado.</li>";

        document.getElementById('textoTotalDiarias').innerText = `Total: ${totalDiarias} di√°rias`;
        document.getElementById('footerTotal').innerText = `Total a Receber: R$ ${totalValor.toFixed(2)}`;
    }

    async function salvarFirebase() {
        if (modoAtual === "admin") await database.ref('saripan').set({ ultAtualizacao: new Date().toISOString(), dados: registros });
    }
    async function carregarDados() {
        const snap = await database.ref('saripan').get();
        if (snap.exists()) registros = snap.val().dados || [];
        atualizarInterface();
    }
    async function fecharQuinzena() {
        if(confirm("Limpar tudo para nova quinzena?")) { registros = []; atualizarInterface(); await salvarFirebase(); }
    }

    // --- PDF ATUALIZADO ---
    async function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18); doc.setTextColor(0,123,255); doc.text("SARIPAN - Relat√≥rio", 14, 20);
        doc.setFontSize(12); doc.setTextColor(0,0,0); doc.text("Prestador: Jo√£o Batista Rosa", 14, 30);
        
        const textoPeriodo = document.getElementById('tituloQuinzena').innerText;
        doc.text(`Refer√™ncia: ${textoPeriodo}`, 14, 38);

        let contadores = { normal: 0, dupla: 0, domingo: 0, feriado: 0, domingoDupla: 0, feriadoDupla: 0 };
        let totalDiarias = 0;
        let totalGeral = 0;

        registros.forEach(reg => {
            totalDiarias += reg.multiplicador;
            totalGeral += reg.valor;
            if (reg.carga === 1 && reg.tipoDia === 1) contadores.normal++;
            else if (reg.carga === 2 && reg.tipoDia === 1) contadores.dupla++;
            else if (reg.carga === 1 && reg.tipoDia === 2) contadores.domingo++;
            else if (reg.carga === 1 && reg.tipoDia === 3) contadores.feriado++;
            else if (reg.carga === 2 && reg.tipoDia === 2) contadores.domingoDupla++;
            else if (reg.carga === 2 && reg.tipoDia === 3) contadores.feriadoDupla++;
        });

        let y = 48;
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text("Resumo do Per√≠odo:", 14, y);
        doc.setFont(undefined, 'normal');
        y += 7;

        if (contadores.normal > 0) { doc.text(`- ${contadores.normal} di√°ria(s) normal`, 14, y); y += 6; }
        if (contadores.dupla > 0) { doc.text(`- ${contadores.dupla} di√°ria(s) dupla`, 14, y); y += 6; }
        if (contadores.domingo > 0) { doc.text(`- ${contadores.domingo} domingo(s)`, 14, y); y += 6; }
        if (contadores.feriado > 0) { doc.text(`- ${contadores.feriado} feriado(s)`, 14, y); y += 6; }
        if (contadores.domingoDupla > 0) { doc.text(`- ${contadores.domingoDupla} domingo(s) Di√°ria Dupla`, 14, y); y += 6; }
        if (contadores.feriadoDupla > 0) { doc.text(`- ${contadores.feriadoDupla} feriado(s) Di√°ria Dupla`, 14, y); y += 6; }
        
        y += 4;
        doc.setFont(undefined, 'bold');
        doc.setTextColor(211, 47, 47);
        doc.text(`Total: ${totalDiarias} di√°rias`, 14, y);
        
        doc.setTextColor(0, 0, 0); 
        doc.setFont(undefined, 'normal');
        y += 10; 

        let dadosTabela = registros.map(reg => {
            let desc = "";
            
            if (reg.tipoDia === 3) desc = "Feriado";
            else if (reg.tipoDia === 2) desc = "Domingo";
            else desc = "Di√°ria Normal";
            
            if (reg.carga === 2) {
                if (reg.tipoDia === 1) {
                    desc = "Di√°ria Dupla"; 
                } else {
                    if (reg.tipoDia === 3) desc = "Feriado (Di√°ria Dupla)";
                    if (reg.tipoDia === 2) desc = "Domingo (Di√°ria Dupla)";
                }
            }
            
            return [
                reg.dataFormatada,
                desc,
                `R$ ${reg.valor.toFixed(2)}`
            ];
        });

        doc.autoTable({ 
            startY: y,
            head: [['Data', 'Descri√ß√£o', 'Valor']], 
            body: dadosTabela, 
            theme: 'grid',
            headStyles: { fillColor: [0, 123, 255] },
            columnStyles: { 0: { cellWidth: 30 }, 2: { cellWidth: 35, halign: 'right' } }
        });
        
        let finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(14); doc.setFont(undefined, 'bold');
        doc.text(`Valor Total: R$ ${totalGeral.toFixed(2)}`, 14, finalY);
        
        doc.save('relatorio_saripan.pdf');
    }
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then((registration) => {
          console.log('SW registrado com sucesso:', registration.scope);
          
          // Se detectar que um novo SW foi encontrado (mudan√ßa de vers√£o)
          registration.onupdatefound = () => {
            const newWorker = registration.installing;
            newWorker.onstatechange = () => {
              if (newWorker.state === 'installed') {
                if (navigator.serviceWorker.controller) {
                  // Nova atualiza√ß√£o dispon√≠vel!
                  console.log('Nova vers√£o dispon√≠vel. Recarregando...');
                  window.location.reload(); // Recarrega a p√°gina automaticamente
                }
              }
            };
          };
        }).catch((err) => {
          console.log('Falha ao registrar SW:', err);
        });
      });

      // Garante que a p√°gina recarregue se o SW assumir o controle
      let refreshing;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        window.location.reload();
        refreshing = true;
      });
    }
  </script>
</body>
</html>
