<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SARIPAN</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
  <meta name="theme-color" content="#d32f2f">

  <style>
    /* Global Styles */
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        background-color: #f0f2f5; 
        margin: 0; 
        padding: 0; 
        height: 100vh; 
        overflow: hidden; 
    }

    .container { 
        background-color: #fff; 
        max-width: 800px; 
        margin: 0 auto; 
        height: 100%; 
        display: flex; 
        flex-direction: column; 
        box-shadow: 0 0 15px rgba(0,0,0,0.05); 
        position: relative; 
    }

    /* √ÅREA FIXA (N√ÉO ROLA) */
    .fixed-area {
        flex-shrink: 0;
        z-index: 10;
        background: white;
    }

    /* Header */
    .app-header { 
        background: #0d47a1; 
        color: white; 
        padding: 15px; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
    }
    .app-title { font-size: 20px; font-weight: bold; margin: 0; }
    .btn-nav-top { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
    
    /* Abas Superiores */
    .tabs-container { display: flex; background: #fff; border-bottom: 1px solid #ddd; }
    .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-size: 16px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: background 0.2s; }
    .tab-btn.active { color: #0d47a1; border-bottom: 3px solid #0d47a1; background: #f9f9f9; }

    /* √ÅREA DE ROLAGEM (SCROLL) */
    .scroll-content {
        flex-grow: 1; 
        overflow-y: auto; 
        background: #f0f2f5;
        position: relative;
    }

    /* Pain√©is */
    .panel { 
        display: none; 
        padding: 15px; 
        padding-bottom: 80px; 
        animation: fadeIn 0.3s; 
    }
    .panel.active { display: block; }

    /* Formul√°rio de Registro */
    .form-box { background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; margin-bottom: 20px; }
    .form-title { margin-top: 0; color: #1565c0; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #bbdefb; padding-bottom: 5px; }
    .grid-input { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    label { font-size: 13px; font-weight: bold; color: #444; display: block; margin-bottom: 4px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
    .btn-action { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; font-size: 16px; margin-top: 10px; }
    .btn-green { background-color: #2e7d32; }
    .btn-red { background-color: #c62828; }

    /* MODAL LOGIN */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 2000;
        display: flex; align-items: center; justify-content: center;
    }
    .modal-content {
        background: white; padding: 25px; border-radius: 12px;
        width: 90%; max-width: 350px; text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .modal-title { font-size: 20px; font-weight: bold; color: #0d47a1; margin-bottom: 20px; }
    .input-login { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
    .btn-close-modal { background: #ccc; margin-top: 10px; color: #333; }

    /* ACORDE√ÉO (Listas Quinzenais) */
    .accordion-group { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; }
    .accordion-header { background: #f5f5f5; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; border-left: 5px solid #0d47a1; }
    .accordion-header.active { background: #e8eaf6; }
    .accordion-title { font-weight: bold; color: #333; font-size: 15px; }
    .accordion-meta { font-size: 12px; color: #666; margin-top: 2px; }
    .accordion-actions { display: flex; gap: 10px; }
    .btn-icon { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }
    
    .accordion-content { display: none; padding: 0; }
    .accordion-content.open { display: block; }

    /* Tabela Interna (Visual App) */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 5px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #eee; color: #555; font-size: 12px; text-transform: uppercase; }
    tr:last-child td { border-bottom: none; }
    .td-valor { font-weight: bold; color: #2e7d32; text-align: right; }
    .td-acao { text-align: center; width: 30px; }
    .total-row { background: #e8f5e9; font-weight: bold; }

    /* FINANCEIRO */
    .year-summary { 
        background: #fff8e1; border: 1px solid #ffe0b2; border-radius: 8px; padding: 15px; 
        margin-bottom: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .year-summary h4 { margin: 0; color: #f57c00; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
    .year-total-value { font-size: 24px; font-weight: bold; color: #333; margin-top: 5px; }

    .fin-table { width: 100%; border: 1px solid #ddd; background: white; }
    .fin-table th { background: #0d47a1; color: white; }
    .fin-table td { border: 1px solid #ddd; }
    .fin-row-total { background: #fff3e0; font-weight: bold; color: #e65100; }

    /* Tela Inicial */
    #inicio { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #fff; width: 100%; position: absolute; top:0; left:0; z-index: 200; }
    .btn-big { padding: 15px 30px; font-size: 18px; margin: 10px; border-radius: 30px; border: none; color: white; width: 80%; max-width: 300px; cursor: pointer; }

    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div id="modal-login" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-title">üîê Acesso Administrativo</div>
        <input type="email" id="emailLogin" class="input-login" placeholder="E-mail" autocomplete="username">
        <input type="password" id="senhaLogin" class="input-login" placeholder="Senha" autocomplete="current-password">
        <button class="btn-action btn-green" onclick="fazerLogin()">Entrar</button>
        <button class="btn-action btn-close-modal" onclick="fecharModalLogin()">Cancelar</button>
    </div>
  </div>

  <div id="inicio">
    <h1 style="color:#d32f2f; font-size: 40px; margin-bottom: 5px;">SARIPAN</h1>
    <p style="color:#666; margin-bottom: 40px;">Gest√£o Inteligente de Di√°rias</p>
    
    <button class="btn-big btn-green" onclick="entrarModo('admin')">üìã Acessar Sistema</button>
    <button class="btn-big" style="background:#1976d2;" onclick="entrarModo('view')">üëÅÔ∏è Apenas Visualizar</button>
  </div>

  <div id="app" class="container hidden">
    
    <div class="fixed-area">
        <div class="app-header">
          <button class="btn-nav-top" onclick="sairApp()">‚¨Ö Sair</button>
          <div class="app-title">SARIPAN</div>
          <div style="width: 50px;"></div>
        </div>

        <div class="tabs-container">
          <button class="tab-btn active" onclick="mudarAba('apontamentos')">üìù Apontamentos</button>
          <button id="btn-tab-financeiro" class="tab-btn" onclick="mudarAba('financeiro')">üí∞ Financeiro</button>
        </div>
    </div>

    <div class="scroll-content">
        
        <div id="painel-apontamentos" class="panel active">
          
          <div id="area-formulario" class="form-box hidden">
            <h3 class="form-title">Novo Registro</h3>
            <label>Data do Servi√ßo:</label>
            <input type="date" id="dataServico" style="margin-bottom: 10px;">
            
            <div class="grid-input">
              <div>
                <label>Tipo:</label>
                <select id="tipoCarga">
                  <option value="1">Normal</option>
                  <option value="2">Dupla</option>
                </select>
              </div>
              <div>
                <label>Detalhes:</label>
                <select id="tipoDia">
                  <option value="1">Dia √ötil</option>
                  <option value="2">Domingo</option>
                  <option value="3">Feriado</option>
                </select>
              </div>
            </div>

            <div class="grid-input">
              <div>
                <label>Valor Base (R$):</label>
                <input type="number" id="valorBase" value="130.00">
              </div>
              <div>
                <label>Previs√£o:</label>
                <input type="text" id="previewValor" readonly style="background: #eee; font-weight: bold; color: #2e7d32;">
              </div>
            </div>

            <button class="btn-action btn-green" onclick="adicionarRegistro()">‚úÖ Confirmar Apontamento</button>
          </div>

          <div id="lista-quinzenas-container"></div>
          
          <div id="msg-sem-dados" style="text-align:center; padding: 40px; color:#999; display:none;">
            Nenhum registro encontrado.
          </div>
        </div>

        <div id="painel-financeiro" class="panel">
          <div id="financeiro-content"></div>
        </div>

    </div> </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    // --- VARI√ÅVEIS GLOBAIS ---
    let modoAtual = ""; 
    let registros = [];
    let database = null; 
    let auth = null; // Inst√¢ncia de autentica√ß√£o
    const MESES = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    // --- SISTEMA DE LOGIN VIA E-MAIL (NOVO) ---
    function entrarModo(modo) {
        if (!database || !auth) {
            iniciarFirebase();
            if(!database) return alert("Erro: Conex√£o com Firebase falhou. Verifique internet.");
        }

        modoAtual = modo;

        if (modo === 'admin') {
            // Verifica se J√Å est√° logado
            const user = auth.currentUser;
            if (user) {
                // J√° logado, entra direto
                abrirAppAdmin();
            } else {
                // N√£o logado, abre modal
                document.getElementById('modal-login').classList.remove('hidden');
            }
        } else {
            // Modo View n√£o precisa de login
            abrirAppView();
        }
    }

    function fecharModalLogin() {
        document.getElementById('modal-login').classList.add('hidden');
    }

    function fazerLogin() {
        const email = document.getElementById('emailLogin').value;
        const senha = document.getElementById('senhaLogin').value;

        if (!email || !senha) return alert("Preencha e-mail e senha.");

        auth.signInWithEmailAndPassword(email, senha)
            .then((userCredential) => {
                // Sucesso
                fecharModalLogin();
                // Limpa campos
                document.getElementById('emailLogin').value = '';
                document.getElementById('senhaLogin').value = '';
                abrirAppAdmin();
            })
            .catch((error) => {
                let msg = "Erro ao entrar.";
                if (error.code === 'auth/wrong-password') msg = "Senha incorreta.";
                if (error.code === 'auth/user-not-found') msg = "Usu√°rio n√£o encontrado.";
                if (error.code === 'auth/invalid-email') msg = "E-mail inv√°lido.";
                alert(msg);
                console.error(error);
            });
    }

    function abrirAppAdmin() {
        document.getElementById('inicio').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        document.getElementById('area-formulario').classList.remove('hidden');
        document.getElementById('btn-tab-financeiro').style.display = 'block';
        
        mudarAba('apontamentos');
        document.getElementById('dataServico').valueAsDate = new Date();
        atualizarPreview();
        carregarDados();
    }

    function abrirAppView() {
        document.getElementById('inicio').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        document.getElementById('area-formulario').classList.add('hidden');
        document.getElementById('btn-tab-financeiro').style.display = 'none';
        
        mudarAba('apontamentos');
        carregarDados();
    }

    function sairApp() {
        if (modoAtual === 'view') {
            location.reload();
            return;
        }
        
        if(confirm("Sair do sistema?")) {
            if (auth) {
                auth.signOut().then(() => {
                    location.reload();
                });
            } else {
                location.reload();
            }
        }
    }

    // --- DEMIAS FUN√á√ïES (IGUAIS ANTERIORMENTE) ---
    function mudarAba(aba) {
        if (aba === 'financeiro' && modoAtual !== 'admin') return;

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        
        if (aba === 'apontamentos') {
            document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            document.getElementById('painel-apontamentos').classList.add('active');
        } else {
            document.getElementById('btn-tab-financeiro').classList.add('active');
            document.getElementById('painel-financeiro').classList.add('active');
            renderizarFinanceiro();
        }
    }

    function calcularValor(base, carga, tipoDia) {
        let pesoDia = (tipoDia === 3 || tipoDia === 2) ? 2 : 1;
        let multiplicador = (pesoDia === 2 && carga === 2) ? 4 : (carga * pesoDia);
        return { multiplicador: multiplicador, total: base * multiplicador };
    }

    function atualizarPreview() {
        const base = parseFloat(document.getElementById('valorBase').value) || 0;
        const carga = parseInt(document.getElementById('tipoCarga').value);
        const tipoDia = parseInt(document.getElementById('tipoDia').value);
        const calc = calcularValor(base, carga, tipoDia);
        document.getElementById('previewValor').value = `R$ ${calc.total.toFixed(2)}`;
    }

    async function adicionarRegistro() {
        if (modoAtual !== 'admin') return;

        const dataInput = document.getElementById('dataServico').value;
        if (!dataInput) return alert("Data inv√°lida!");

        const base = parseFloat(document.getElementById('valorBase').value);
        const carga = parseInt(document.getElementById('tipoCarga').value);
        const tipoDia = parseInt(document.getElementById('tipoDia').value);
        
        const calc = calcularValor(base, carga, tipoDia);
        
        const dateObj = new Date(dataInput);
        const ano = dateObj.getUTCFullYear();
        const mesIndex = dateObj.getUTCMonth(); 
        const dia = dateObj.getUTCDate();
        const quinzena = dia <= 15 ? 1 : 2;

        const novoReg = {
            id: Date.now(),
            data: dataInput,
            ano: ano,
            mes: mesIndex,
            quinzena: quinzena,
            carga: carga,
            tipoDia: tipoDia,
            valorBase: base,
            multiplicador: calc.multiplicador,
            total: calc.total
        };

        registros.push(novoReg);
        await salvarFirebase();
        renderizarApontamentos();
        alert("Registro salvo!");
    }

    async function excluirRegistro(id) {
        if (modoAtual !== 'admin') return;
        if(!confirm("Excluir este registro?")) return;
        registros = registros.filter(r => r.id !== id);
        await salvarFirebase();
        renderizarApontamentos();
    }

    async function excluirQuinzena(chaveGrupo) {
        if (modoAtual !== 'admin') return;
        if (!confirm("ATEN√á√ÉO: Isso apagar√° TODOS os registros desta quinzena.\n\nTem certeza?")) return;
        const [ano, mes, q] = chaveGrupo.split('-').map(Number);
        registros = registros.filter(r => !(r.ano === ano && r.mes === mes && r.quinzena === q));
        await salvarFirebase();
        renderizarApontamentos();
    }

    function toggleAccordion(header) {
        header.classList.toggle('active');
        const content = header.nextElementSibling;
        content.classList.toggle('open');
        const seta = header.querySelector('span:last-child');
        seta.innerText = content.classList.contains('open') ? '‚ñº' : '‚ñ∂';
    }

    function renderizarApontamentos() {
        const container = document.getElementById('lista-quinzenas-container');
        container.innerHTML = "";

        if (registros.length === 0) {
            document.getElementById('msg-sem-dados').style.display = 'block';
            return;
        }
        document.getElementById('msg-sem-dados').style.display = 'none';

        const grupos = {};
        registros.forEach(reg => {
            const chave = `${reg.ano}-${reg.mes}-${reg.quinzena}`;
            if (!grupos[chave]) {
                grupos[chave] = {
                    ano: reg.ano,
                    mes: reg.mes,
                    quinzena: reg.quinzena,
                    itens: [],
                    totalValor: 0
                };
            }
            grupos[chave].itens.push(reg);
            grupos[chave].totalValor += reg.total;
        });

        const chavesOrdenadas = Object.keys(grupos).sort((a, b) => {
            const [aA, aM, aQ] = a.split('-').map(Number);
            const [bA, bM, bQ] = b.split('-').map(Number);
            if (aA !== bA) return bA - aA;
            if (aM !== bM) return bM - aM;
            return bQ - aQ;
        });

        let chavesFinais = chavesOrdenadas;
        if (modoAtual === 'view') {
            const hoje = new Date();
            const anoH = hoje.getFullYear();
            const mesH = hoje.getMonth();
            const diaH = hoje.getDate();
            const quinzH = diaH <= 15 ? 1 : 2;
            const chaveVigente = `${anoH}-${mesH}-${quinzH}`;
            chavesFinais = chavesOrdenadas.filter(k => k === chaveVigente);
            
            if (chavesFinais.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:30px; color:#666;">
                    <h3>Nenhum registro para a quinzena vigente.</h3>
                    <p>Refer√™ncia: ${quinzH}¬™ Quinzena de ${MESES[mesH]}</p>
                </div>`;
                return;
            }
        }

        chavesFinais.forEach((chave, index) => {
            const grupo = grupos[chave];
            grupo.itens.sort((a, b) => new Date(a.data) - new Date(b.data));
            const totalPeso = grupo.itens.reduce((acc, item) => acc + item.multiplicador, 0);
            const isFirst = index === 0; 
            const nomeMes = MESES[grupo.mes];
            const titulo = `${grupo.quinzena}¬™ Quinzena de ${nomeMes} ${grupo.ano}`;
            const totalFormatado = grupo.totalValor.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            const div = document.createElement('div');
            div.className = 'accordion-group';
            
            let btnPDF = '';
            let btnDeleteHTML = '';
            let metaTexto = '';
            let thValor = '';
            let thAcao = '';
            let totalRowHTML = '';

            if (modoAtual === 'admin') {
                metaTexto = `${grupo.itens.length} registros ‚Ä¢ Total: ${totalFormatado}`;
                btnPDF = `<button class="btn-icon" style="color:#1976d2;" onclick="event.stopPropagation(); gerarPDF('${chave}')" title="Baixar PDF">üìÑ</button>`;
                btnDeleteHTML = `<button class="btn-icon" style="color:#d32f2f;" onclick="event.stopPropagation(); excluirQuinzena('${chave}')" title="Excluir Quinzena">üóëÔ∏è</button>`;
                thValor = '<th style="text-align:right">Valor</th>';
                thAcao = '<th class="td-acao"></th>';
                totalRowHTML = `
                    <tr class="total-row">
                        <td colspan="3">Total do Per√≠odo</td>
                        <td class="td-valor">${totalFormatado}</td>
                        <td></td>
                    </tr>`;
            } else {
                metaTexto = `${grupo.itens.length} registros trabalhados`;
                btnPDF = ''; 
                btnDeleteHTML = ''; 
                thValor = ''; 
                thAcao = ''; 
                totalRowHTML = `
                    <tr class="total-row">
                        <td colspan="3" style="text-align: left; padding: 12px;">
                            <div style="margin-bottom:4px;">Total de Dias Trabalhados: ${grupo.itens.length}</div>
                            <div style="color:#0d47a1; font-weight:bold;">Total de Di√°rias a receber: ${totalPeso}</div>
                        </td>
                    </tr>`;
            }

            div.innerHTML = `
                <div class="accordion-header ${isFirst ? 'active' : ''}" onclick="toggleAccordion(this)">
                    <div>
                        <div class="accordion-title">${titulo}</div>
                        <div class="accordion-meta">${metaTexto}</div>
                    </div>
                    <div class="accordion-actions">
                        ${btnPDF}
                        ${btnDeleteHTML}
                        <span style="margin-left:5px; font-size:12px;">${isFirst ? '‚ñº' : '‚ñ∂'}</span>
                    </div>
                </div>
                <div class="accordion-content ${isFirst ? 'open' : ''}">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Detalhes</th>
                                ${thValor}
                                ${thAcao}
                            </tr>
                        </thead>
                        <tbody>
                            ${grupo.itens.map(item => {
                                const diaStr = item.data.split('-')[2];
                                const tipoStr = item.carga === 1 ? 'Normal' : 'Dupla';
                                const detalheStr = item.tipoDia === 1 ? 'Dia √ötil' : item.tipoDia === 2 ? 'Domingo' : 'Feriado';
                                
                                let tdValor = '';
                                let tdAcao = '';

                                if (modoAtual === 'admin') {
                                    tdValor = `<td class="td-valor">R$ ${item.total.toFixed(2)}</td>`;
                                    tdAcao = `<td class="td-acao"><span style="color:red; cursor:pointer;" onclick="excluirRegistro(${item.id})">‚úñ</span></td>`;
                                }

                                return `
                                    <tr>
                                        <td>${diaStr}/${(item.mes+1).toString().padStart(2,'0')}</td>
                                        <td>${tipoStr}</td>
                                        <td>${detalheStr}</td>
                                        ${tdValor}
                                        ${tdAcao}
                                    </tr>
                                `;
                            }).join('')}
                            ${totalRowHTML}
                        </tbody>
                    </table>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function renderizarFinanceiro() {
        if (modoAtual !== 'admin') return;

        const container = document.getElementById('financeiro-content');
        container.innerHTML = "";

        const dadosMes = {}; 
        const totaisAnuais = {};

        registros.forEach(reg => {
            const chaveMes = `${reg.ano}-${reg.mes}`;
            if (!dadosMes[chaveMes]) {
                dadosMes[chaveMes] = { ano: reg.ano, mes: reg.mes, q1: 0, q2: 0 };
            }
            if (reg.quinzena === 1) dadosMes[chaveMes].q1 += reg.total;
            else dadosMes[chaveMes].q2 += reg.total;

            if (!totaisAnuais[reg.ano]) totaisAnuais[reg.ano] = 0;
            totaisAnuais[reg.ano] += reg.total;
        });

        const chavesMes = Object.keys(dadosMes).sort((a,b) => {
             const [aA, aM] = a.split('-').map(Number);
             const [bA, bM] = b.split('-').map(Number);
             if (aA !== bA) return bA - aA;
             return bM - aM;
        });
        
        const anosOrdenados = Object.keys(totaisAnuais).sort((a,b) => b-a); 

        if (chavesMes.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding:20px;'>Sem dados financeiros.</p>";
            return;
        }

        let htmlAnual = '';
        anosOrdenados.forEach(ano => {
            const valor = totaisAnuais[ano].toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            htmlAnual += `
                <div class="year-summary">
                    <h4>Total Acumulado ${ano}</h4>
                    <div class="year-total-value">${valor}</div>
                </div>
            `;
        });
        container.innerHTML += htmlAnual;

        let htmlTable = `
            <table class="fin-table">
                <thead>
                    <tr>
                        <th>M√™s/Ano</th>
                        <th style="text-align:right">1¬™ Q.</th>
                        <th style="text-align:right">2¬™ Q.</th>
                        <th style="text-align:right; background:#003c8f; color:white;">Total</th>
                    </tr>
                </thead>
                <tbody>
        `;

        chavesMes.forEach(k => {
            const d = dadosMes[k];
            const total = d.q1 + d.q2;
            htmlTable += `
                <tr>
                    <td>${MESES[d.mes]} ${d.ano}</td>
                    <td style="text-align:right">R$ ${d.q1.toFixed(2)}</td>
                    <td style="text-align:right">R$ ${d.q2.toFixed(2)}</td>
                    <td style="text-align:right" class="fin-row-total">R$ ${total.toFixed(2)}</td>
                </tr>
            `;
        });

        htmlTable += `</tbody></table>`;
        container.innerHTML += htmlTable;
    }

    function gerarPDF(chaveGrupo) {
        if (modoAtual !== 'admin') return;
        
        const [ano, mes, q] = chaveGrupo.split('-').map(Number);
        const itens = registros.filter(r => r.ano === ano && r.mes === mes && r.quinzena === q);
        itens.sort((a, b) => new Date(a.data) - new Date(b.data));

        if (itens.length === 0) return alert("Erro: Sem dados.");

        let contagem = { normal: 0, dupla: 0, feriado: 0, domingo: 0, feriadoDupla: 0, domingoDupla: 0 };
        let totalMultiplicador = 0;
        let totalDinheiro = 0;

        itens.forEach(i => {
            totalMultiplicador += i.multiplicador;
            totalDinheiro += i.total;
            if (i.carga === 1) {
                if (i.tipoDia === 1) contagem.normal++;
                else if (i.tipoDia === 2) contagem.domingo++;
                else if (i.tipoDia === 3) contagem.feriado++;
            } else { 
                if (i.tipoDia === 1) contagem.dupla++;
                else if (i.tipoDia === 2) contagem.domingoDupla++;
                else if (i.tipoDia === 3) contagem.feriadoDupla++;
            }
        });

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text("SARIPAN - Relat√≥rio", 14, 20);
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text("Prestador: Jo√£o Batista Rosa", 14, 28);
        const nomeMes = MESES[mes];
        doc.text(`Refer√™ncia: ${q}¬™ Quinzena de ${nomeMes}`, 14, 34);
        
        doc.setFont(undefined, 'bold');
        doc.text("Resumo do Per√≠odo:", 14, 44);
        doc.setFont(undefined, 'normal');
        
        let y = 50;
        if (contagem.normal > 0) { doc.text(`- ${contagem.normal} di√°ria(s) normal`, 14, y); y += 6; }
        if (contagem.dupla > 0) { doc.text(`- ${contagem.dupla} di√°ria(s) dupla`, 14, y); y += 6; }
        if (contagem.feriado > 0) { doc.text(`- ${contagem.feriado} feriado(s) normal`, 14, y); y += 6; }
        if (contagem.domingo > 0) { doc.text(`- ${contagem.domingo} domingo(s)`, 14, y); y += 6; }
        if (contagem.feriadoDupla > 0) { doc.text(`- ${contagem.feriadoDupla} feriado(s) dupla`, 14, y); y += 6; }
        if (contagem.domingoDupla > 0) { doc.text(`- ${contagem.domingoDupla} domingo(s) dupla`, 14, y); y += 6; }

        doc.setFont(undefined, 'bold');
        y += 2;
        doc.text(`Total: ${totalMultiplicador} di√°rias a receber`, 14, y);

        const bodyData = itens.map(i => {
            const tipoStr = i.carga === 1 ? 'Normal' : 'Dupla';
            const detalheStr = i.tipoDia === 1 ? 'Dia √ötil' : i.tipoDia === 2 ? 'Domingo' : 'Feriado';
            
            return [
                i.data.split('-').reverse().join('/'),
                tipoStr,
                detalheStr,
                `R$ ${i.total.toFixed(2)}`
            ];
        });

        doc.autoTable({
            startY: y + 10,
            head: [['Data', 'Tipo', 'Detalhes', 'Valor']], 
            body: bodyData,
            theme: 'grid', 
            headStyles: { 
                fillColor: [0, 176, 240], 
                textColor: [0, 0, 0],     
                fontStyle: 'bold',
                halign: 'center',
                lineColor: [0, 0, 0],
                lineWidth: 0.1
            },
            bodyStyles: {
                textColor: [0, 0, 0],
                halign: 'center',
                lineColor: [0, 0, 0],
                lineWidth: 0.1
            },
            foot: [['', '', 'Valor Total:', `R$ ${totalDinheiro.toFixed(2)}`]],
            footStyles: {
                fillColor: [255, 255, 255],
                textColor: [0, 0, 0],
                fontStyle: 'bold',
                halign: 'center',
                lineColor: [0, 0, 0],
                lineWidth: 0.1
            }
        });

        doc.save(`Saripan_${nomeMes}_${ano}_Q${q}.pdf`);
    }

    async function salvarFirebase() {
        if (modoAtual === "admin" && database) {
            await database.ref('saripan_v2').set({ 
                ultAtualizacao: new Date().toISOString(), 
                dados: registros 
            });
        }
    }

    async function carregarDados() {
        if (!database) return;
        try {
            const snap = await database.ref('saripan_v2').get();
            if (snap.exists()) {
                registros = snap.val().dados || [];
            } else {
                registros = [];
            }
            renderizarApontamentos();
        } catch (e) {
            console.error("Erro ao carregar:", e);
        }
    }

    // --- SETUP INICIAL BLINDADO ---
    function iniciarFirebase() {
        try {
            const firebaseConfig = {
              apiKey: "AIzaSyDSVOvdkIaV37Cxm3btE_T3zuDOQm2Uu5s",
              authDomain: "saripan-db.firebaseapp.com",
              databaseURL: "https://saripan-db-default-rtdb.firebaseio.com",
              projectId: "saripan-db",
              storageBucket: "saripan-db.firebasestorage.app",
              messagingSenderId: "1:80320414744:web:958b3a99462d97575e2f6d",
              appId: "G-9W62N5PFV9"
            };
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                auth = firebase.auth(); // Inicia Auth
                console.log("Firebase e Auth conectados.");
            } else {
                console.warn("Firebase SDK n√£o carregado (Offline?).");
            }
        } catch (e) {
            console.error("Erro ao iniciar Firebase:", e);
        }
    }

    window.addEventListener('DOMContentLoaded', () => {
        iniciarFirebase();
        
        ['valorBase', 'tipoCarga', 'tipoDia'].forEach(id => document.getElementById(id).addEventListener('input', atualizarPreview));
        
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js');
        }
    });
  </script>
</body>
</html>
